<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>EPUB ÎØ∏Î¶¨Î≥¥Í∏∞</title>
  <style>
    :root{ --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e2e8f0; --accent:#22c55e; }
    *{box-sizing:border-box}
    body{margin:0;padding:16px;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
    .wrap{max-width:980px;margin:0 auto}
    h1{font-size:20px;margin:0 0 12px}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .bar a.btn,.bar button.btn{padding:8px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1220;color:var(--text);text-decoration:none}
    .bar .primary{background:var(--accent);color:#052e13;border:none;font-weight:700}
    #viewer{height:80vh;border:1px solid #1f2937;border-radius:12px;background:#0b1220;overflow:hidden}
    select,input{padding:8px 10px;background:#0b1220;color:var(--text);border:1px solid #1f2937;border-radius:10px}
    .muted{color:var(--muted);font-size:12px}
    .error{padding:12px;border:1px solid #7f1d1d;background:#1f0b0b;border-radius:12px;color:#fecaca;margin-top:10px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>üìñ EPUB ÎØ∏Î¶¨Î≥¥Í∏∞</h1>
  <div class="bar">
    <button id="prev" class="btn">‚Üê Ïù¥Ï†Ñ</button>
    <button id="next" class="btn">Îã§Ïùå ‚Üí</button>
    <label class="muted">Î™©Ï∞®</label>
    <select id="toc"></select>
    <a id="download" class="btn primary" href="#" download>EPUB Îã§Ïö¥Î°úÎìú</a>
    <span id="meta" class="muted"></span>
  </div>
  <div id="viewer"></div>
  <div id="msg" class="error" style="display:none"></div>
</div>

<!-- ‚ö†Ô∏è Í∞ÄÎä•ÌïòÎã§Î©¥ js/epub.min.js Î°ú ÍµêÏ≤¥ Ï∂îÏ≤ú -->
<script src="js/epub.min.js"></script>
<script>
(function(){
  const params = new URLSearchParams(location.search);
  let bookUrl = params.get('book') || '';
  const msg = document.getElementById('msg');
  const tocSel = document.getElementById('toc');
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  const downloadA = document.getElementById('download');
  const meta = document.getElementById('meta');

  if(!bookUrl){
    msg.style.display='block';
    msg.textContent = 'book ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Ïòà: viewer.html?book=epub/test.epub';
    return;
  }

  // Ìï≠ÏÉÅ epub/ ÌïòÏúÑ Ìè¥ÎçîÎ°ú Í≤ΩÎ°ú ÎßûÏ∂îÍ∏∞
  bookUrl = bookUrl.replace(/^\\/?/, ''); // Îß® Ïïû Ïä¨ÎûòÏãú Ï†úÍ±∞
  if(!bookUrl.startsWith('epub/')) {
    bookUrl = 'epub/' + bookUrl;
  }

  const repoName = location.pathname.split("/")[1]; // "epub-hub"
  const baseUrl = location.origin + "/" + repoName + "/";
  const resolved = new URL(bookUrl, baseUrl);

  downloadA.href = resolved.href;

  try {
    const book = ePub(resolved.href);
    const rendition = book.renderTo("viewer", { width: "100%", height: "100%" });
    rendition.display();

    prevBtn.addEventListener('click', () => rendition.prev());
    nextBtn.addEventListener('click', () => rendition.next());

    // TOC
    book.loaded.navigation.then(function(toc){
      tocSel.innerHTML = "";
      (toc.toc || []).forEach(function(ch){
        const opt = document.createElement('option');
        opt.value = ch.href;
        opt.textContent = ch.label;
        tocSel.appendChild(opt);
      });
      tocSel.addEventListener('change', function(){
        const href = this.value;
        if(href) book.rendition.display(href);
      });
    });

    // Metadata
    book.loaded.metadata.then(function(m){
      const bits = [];
      if(m.title) bits.push(m.title);
      if(m.creator) bits.push(m.creator);
      if(m.publisher) bits.push(m.publisher);
      if(bits.length) meta.textContent = 'Î©îÌÉÄ: ' + bits.join(' ¬∑ ');
    });
  } catch(e){
    msg.style.display='block';
    msg.textContent = 'ÎØ∏Î¶¨Î≥¥Í∏∞ Ïò§Î•ò: ' + (e && e.message ? e.message : e);
  }
})();
</script>
</body>
</html>

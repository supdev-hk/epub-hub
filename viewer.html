<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPUB 미리보기</title>
    <style>
      body {
        margin: 0;
        padding: 16px;
        background: #0f172a; /* 페이지 배경은 어두운색 유지 */
        color: #e2e8f0;
        font-family: sans-serif;
      }
      #viewer {
        width: 100%;
        height: 600px;
        min-height: 400px;
        border: 2px solid #22c55e;
        border-radius: 8px;
        background: #0b1220; /* 뷰어 영역 배경 */
        overflow: hidden;
      }
      .bar {
        margin-bottom: 10px;
      }
      .btn {
        padding: 6px 10px;
        margin-right: 6px;
        border-radius: 6px;
        border: 1px solid #1f2937;
        background: #22c55e;
        color: #052e13;
        cursor: pointer;
        font-weight: bold;
      }
      .error {
        margin-top: 10px;
        padding: 10px;
        background: #1f0b0b;
        color: #fecaca;
        border: 1px solid #7f1d1d;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div>
      <button id="home" onclick="location.href='index.html'" class="btn">
        🏠 홈으로
      </button>
    </div>
    <h2>📖 EPUB 미리보기</h2>
    <div class="bar">
      <button id="prev" class="btn">← 이전</button>
      <button id="next" class="btn">다음 →</button>
      <select id="toc"></select>
      <a
        id="download"
        class="btn"
        href="#"
        style="text-decoration: none"
        download
        >다운로드</a
      >
      <div id="meta"></div>
    </div>
    <div id="viewer"></div>
    <div id="msg" class="error" style="display: none"></div>

    <!-- jszip (epub.js 필수) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <!-- epub.js -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>

    <script>
      (function () {
        console.log("✅ viewer.html 실행 시작");

        const p = new URLSearchParams(location.search);
        let bookUrl = p.get("book");
        console.log("📌 raw book param =", bookUrl);

        const msg = document.getElementById("msg");
        const tocSel = document.getElementById("toc");
        const prevBtn = document.getElementById("prev");
        const nextBtn = document.getElementById("next");
        const downloadA = document.getElementById("download");
        const meta = document.getElementById("meta");

        if (!bookUrl) {
          msg.style.display = "block";
          msg.textContent = "예: viewer.html?book=epub/sample_alice.epub";
          console.error("❌ book 파라미터 없음");
          return;
        }

        // 경로 보정
        bookUrl = bookUrl.replace(/^\//, "");
        console.log("📌 최종 bookUrl =", bookUrl);

        downloadA.href = bookUrl;

        try {
          console.log("📌 ePub 초기화 시도:", bookUrl);
          const book = ePub(bookUrl);

          const rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
          });

          rendition.display().then(() => {
            console.log("✅ rendition.display() 성공");
          });

          // ✅ 라이트 테마 고정
          rendition.themes.register("light", {
            body: {
              color: "#000000 !important",
              background: "#ffffff !important",
            },
            "p, h1, h2, h3, h4, h5, h6": { color: "#000000 !important" },
            a: { color: "#1d4ed8 !important" },
          });
          rendition.themes.select("light");

          // Prev/Next
          prevBtn.addEventListener("click", () => rendition.prev());
          nextBtn.addEventListener("click", () => rendition.next());

          // Navigation
          book.loaded.navigation.then((toc) => {
            tocSel.innerHTML = "";
            (toc.toc || []).forEach((ch) => {
              const opt = document.createElement("option");
              opt.value = ch.href;
              opt.textContent = ch.label;
              tocSel.appendChild(opt);
            });
            tocSel.addEventListener("change", function () {
              if (this.value) rendition.display(this.value);
            });
          });

          // Metadata
          book.loaded.metadata.then((m) => {
            const bits = [];
            if (m.title) bits.push(m.title);
            if (m.creator) bits.push(m.creator);
            if (m.publisher) bits.push(m.publisher);
            if (bits.length) meta.textContent = "정보: " + bits.join(" · ");
          });
        } catch (e) {
          msg.style.display = "block";
          msg.textContent = "미리보기 오류: " + (e.message || e);
        }
      })();
    </script>
  </body>
</html>

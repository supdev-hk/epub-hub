<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPUB 미리보기</title>
    <style>
      body {
        margin: 0;
        padding: 16px;
        background: #0f172a;
        color: #e2e8f0;
        font-family: sans-serif;
      }
      #viewer {
        width: 100%;
        height: 600px;
        min-height: 400px;
        border: 2px solid #22c55e;
        border-radius: 8px;
        background: #0b1220;
        overflow: hidden;
      }
      .bar {
        margin-bottom: 10px;
      }
      .btn {
        padding: 6px 10px;
        margin-right: 6px;
        border-radius: 6px;
        border: 1px solid #1f2937;
        background: #22c55e;
        color: #052e13;
        cursor: pointer;
      }
      .error {
        margin-top: 10px;
        padding: 10px;
        background: #1f0b0b;
        color: #fecaca;
        border: 1px solid #7f1d1d;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div>      
      <button id="home" onclick="location.href='index.html'" class="btn">🏠 홈으로</button>
      
    </div>
    <h2>📖 EPUB 미리보기</h2>
    <div class="bar">
      <button id="prev" class="btn">← 이전</button>
      <button id="next" class="btn">다음 →</button>
      <select id="toc"></select>
      <a id="download" class="btn" href="#" download>다운로드</a>
      <div id="meta"></div>
    </div>
    <div id="viewer"></div>
    <div id="msg" class="error" style="display: none"></div>

    <!-- jszip (epub.js 필수) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <!-- epub.js -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>

    <script>
      (function () {
        console.log("✅ viewer.html 실행 시작");

        const p = new URLSearchParams(location.search);
        let bookUrl = p.get("book");
        console.log("📌 raw book param =", bookUrl);

        const msg = document.getElementById("msg");
        const tocSel = document.getElementById("toc");
        const prevBtn = document.getElementById("prev");
        const nextBtn = document.getElementById("next");
        const downloadA = document.getElementById("download");
        const meta = document.getElementById("meta");

        if (!bookUrl) {
          msg.style.display = "block";
          msg.textContent = "예: viewer.html?book=epub/sample_alice.epub";
          console.error("❌ book 파라미터 없음");
          return;
        }

        // 경로 보정
        bookUrl = bookUrl.replace(/^\//, "");
        console.log("📌 최종 bookUrl =", bookUrl);

        downloadA.href = bookUrl;

        try {
          console.log("📌 ePub 초기화 시도:", bookUrl);
          const book = ePub(bookUrl);

          const rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
          });

          rendition
            .display()
            .then(() => {
              console.log("✅ rendition.display() 성공");
            })
            .catch((e) => {
              console.error("❌ rendition.display() 실패", e);
            });

          // ✅ 다크 테마 강제 적용
          rendition.themes.register("dark", {
            body: {
              color: "#e2e8f0 !important",
              background: "#0f172a !important",
            },
            p: { color: "#e2e8f0 !important" },
            h1: { color: "#e2e8f0 !important" },
            h2: { color: "#e2e8f0 !important" },
            h3: { color: "#e2e8f0 !important" },
            a: { color: "#60a5fa !important" },
          });
          rendition.themes.select("dark");

          // Prev/Next
          prevBtn.addEventListener("click", () => {
            console.log("⬅️ prev");
            rendition.prev();
          });
          nextBtn.addEventListener("click", () => {
            console.log("➡️ next");
            rendition.next();
          });

          // Navigation
          book.loaded.navigation
            .then((toc) => {
              console.log("📌 TOC 로드됨:", toc);
              tocSel.innerHTML = "";
              (toc.toc || []).forEach((ch) => {
                const opt = document.createElement("option");
                opt.value = ch.href;
                opt.textContent = ch.label;
                tocSel.appendChild(opt);
              });
              tocSel.addEventListener("change", function () {
                const href = this.value;
                console.log("📌 TOC 선택:", href);
                if (href) rendition.display(href);
              });
            })
            .catch((e) => console.error("❌ TOC 로드 실패", e));

          // Metadata
          book.loaded.metadata
            .then((m) => {
              console.log("📌 Metadata 로드됨:", m);
              const bits = [];
              if (m.title) bits.push(m.title);
              if (m.creator) bits.push(m.creator);
              if (m.publisher) bits.push(m.publisher);
              if (bits.length) meta.textContent = "정보: " + bits.join(" · ");
            })
            .catch((e) => console.error("❌ Metadata 로드 실패", e));

          // Ready
          book.ready
            .then(() => {
              console.log("✅ book.ready OK");
            })
            .catch((e) => {
              console.error("❌ book.ready 실패", e);
            });
        } catch (e) {
          console.error("❌ ePub init 오류", e);
          msg.style.display = "block";
          msg.textContent =
            "미리보기 오류: " + (e && e.message ? e.message : e);
        }
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPUB ë¯¸ë¦¬ë³´ê¸°</title>
    <style>
      body {
        margin: 0;
        padding: 16px;
        background: #0f172a;
        color: #e2e8f0;
        font-family: sans-serif;
      }
      #viewer {
        width: 100%;
        height: 600px;
        min-height: 400px;
        border: 2px solid #22c55e;
        border-radius: 8px;
        background: #0b1220;
        overflow: hidden;
      }
      .bar {
        margin-bottom: 10px;
      }
      .btn {
        padding: 6px 10px;
        margin-right: 6px;
        border-radius: 6px;
        border: 1px solid #1f2937;
        background: #22c55e;
        color: #052e13;
        cursor: pointer;
      }
      .error {
        margin-top: 10px;
        padding: 10px;
        background: #1f0b0b;
        color: #fecaca;
        border: 1px solid #7f1d1d;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <div>      
      <button id="home" onclick="location.href='index.html'" class="btn">ğŸ  í™ˆìœ¼ë¡œ</button>
      
    </div>
    <h2>ğŸ“– EPUB ë¯¸ë¦¬ë³´ê¸°</h2>
    <div class="bar">
      <button id="prev" class="btn">â† ì´ì „</button>
      <button id="next" class="btn">ë‹¤ìŒ â†’</button>
      <select id="toc"></select>
      <a id="download" class="btn" href="#" download>ë‹¤ìš´ë¡œë“œ</a>
      <div id="meta"></div>
    </div>
    <div id="viewer"></div>
    <div id="msg" class="error" style="display: none"></div>

    <!-- jszip (epub.js í•„ìˆ˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <!-- epub.js -->
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>

    <script>
      (function () {
        console.log("âœ… viewer.html ì‹¤í–‰ ì‹œì‘");

        const p = new URLSearchParams(location.search);
        let bookUrl = p.get("book");
        console.log("ğŸ“Œ raw book param =", bookUrl);

        const msg = document.getElementById("msg");
        const tocSel = document.getElementById("toc");
        const prevBtn = document.getElementById("prev");
        const nextBtn = document.getElementById("next");
        const downloadA = document.getElementById("download");
        const meta = document.getElementById("meta");

        if (!bookUrl) {
          msg.style.display = "block";
          msg.textContent = "ì˜ˆ: viewer.html?book=epub/sample_alice.epub";
          console.error("âŒ book íŒŒë¼ë¯¸í„° ì—†ìŒ");
          return;
        }

        // ê²½ë¡œ ë³´ì •
        bookUrl = bookUrl.replace(/^\//, "");
        console.log("ğŸ“Œ ìµœì¢… bookUrl =", bookUrl);

        downloadA.href = bookUrl;

        try {
          console.log("ğŸ“Œ ePub ì´ˆê¸°í™” ì‹œë„:", bookUrl);
          const book = ePub(bookUrl);

          const rendition = book.renderTo("viewer", {
            width: "100%",
            height: "100%",
          });

          rendition
            .display()
            .then(() => {
              console.log("âœ… rendition.display() ì„±ê³µ");
            })
            .catch((e) => {
              console.error("âŒ rendition.display() ì‹¤íŒ¨", e);
            });

          // âœ… ë‹¤í¬ í…Œë§ˆ ê°•ì œ ì ìš©
          rendition.themes.register("dark", {
            body: {
              color: "#e2e8f0 !important",
              background: "#0f172a !important",
            },
            p: { color: "#e2e8f0 !important" },
            h1: { color: "#e2e8f0 !important" },
            h2: { color: "#e2e8f0 !important" },
            h3: { color: "#e2e8f0 !important" },
            a: { color: "#60a5fa !important" },
          });
          rendition.themes.select("dark");

          // Prev/Next
          prevBtn.addEventListener("click", () => {
            console.log("â¬…ï¸ prev");
            rendition.prev();
          });
          nextBtn.addEventListener("click", () => {
            console.log("â¡ï¸ next");
            rendition.next();
          });

          // Navigation
          book.loaded.navigation
            .then((toc) => {
              console.log("ğŸ“Œ TOC ë¡œë“œë¨:", toc);
              tocSel.innerHTML = "";
              (toc.toc || []).forEach((ch) => {
                const opt = document.createElement("option");
                opt.value = ch.href;
                opt.textContent = ch.label;
                tocSel.appendChild(opt);
              });
              tocSel.addEventListener("change", function () {
                const href = this.value;
                console.log("ğŸ“Œ TOC ì„ íƒ:", href);
                if (href) rendition.display(href);
              });
            })
            .catch((e) => console.error("âŒ TOC ë¡œë“œ ì‹¤íŒ¨", e));

          // Metadata
          book.loaded.metadata
            .then((m) => {
              console.log("ğŸ“Œ Metadata ë¡œë“œë¨:", m);
              const bits = [];
              if (m.title) bits.push(m.title);
              if (m.creator) bits.push(m.creator);
              if (m.publisher) bits.push(m.publisher);
              if (bits.length) meta.textContent = "ì •ë³´: " + bits.join(" Â· ");
            })
            .catch((e) => console.error("âŒ Metadata ë¡œë“œ ì‹¤íŒ¨", e));

          // Ready
          book.ready
            .then(() => {
              console.log("âœ… book.ready OK");
            })
            .catch((e) => {
              console.error("âŒ book.ready ì‹¤íŒ¨", e);
            });
        } catch (e) {
          console.error("âŒ ePub init ì˜¤ë¥˜", e);
          msg.style.display = "block";
          msg.textContent =
            "ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: " + (e && e.message ? e.message : e);
        }
      })();
    </script>
  </body>
</html>
